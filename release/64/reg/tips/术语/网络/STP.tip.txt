2.4.1　扩展树技术

扩展树（SpanningTree），也称生成树，它的产生源于链路的冗余连接。扩展树协议指通过一定算法，使任意两个节点间有且只有一条路径连接。这就好像是一棵树，从树根开始长起，然后是树干、树枝，最后到树叶，从而保证任意两片树叶间只有一条路径。

1．扩展树的作用在大中型的局域网络中，与中心交换机和服务器的连接非常重要，而端口或交换机却不可避免地存在着发生故障的可能性。那么，如何保证在一条链路发生故障之后，还能通过其他链路保持连接不被中断呢？这自然就要采用冗余链接（如图2-12所示）。然而，冗余的链接虽然增加了系统的安全性，但同时也带来了另外一个问题，那就是链路循环（拓扑环），使得数据在交换机之间循环传递，并最终导致网络瘫痪。


图2-12　冗余链接

既然冗余备份是必需的，而又不能让两条以上的链路同时工作，那么唯一途径就是让两条链路中的一条处于工作状态，而另一条处于待命状态。处于待命状态的备份链路必须同时具有监视主链路工作状况的能力，并在主链路发生故障时，立即投入使用。这样既起到了备份的作用，又保证网络不会陷入死循环。于是，扩展树的思路诞生了。另外，借助于扩展树技术，即使由于网络管理员的错误连接而导致了网络的拓扑环路，网络仍然可以正常运行，从而保证网络的连接稳定。

2．STP
通过一定算法，STP使任意两个节点间有且只有一条路径连接，而其他的冗余链路则被自动阻塞，作为备份链路。只有当活动链路失败时，备份链路才会被激活，从而恢复设备之间的连接，保证网络的畅通。

■　STP简介

STP协议是用来避免链路环路产生的广播风暴、并提供链路冗余备份的协议。对二层以太网而言，交换机之间只能有一条活动着的通路，否则就会产生广播风暴。但是，为了提高局域网的可靠性，建立冗余链路又是必要的，其中的一些链路必须处于备份状态，如果当网络发生故障，另一条链路失效时，冗余链路就必须被提升为活动状态。手工控制这样的过程显然是一项非常艰苦的工作，STP协议就自动地完成这项工作，使交换机起到以下作用。发现并启动局域网的一个最佳树型拓朴结构。发现故障并随之进行恢复，自动更新网络拓扑结构，使在任何时候都选择了可能的最佳树型结构。这就好像是一棵树，从树根开始长起，然后是树干、树枝，最后到树叶，从而保证任意两片树叶间只有一条路（如图2-13所示）。而链路选举的标准就是优先级值（Priority）和端口开销（Cost）。不过，Spanning-Tree的优点是可以在任何端口实现，而不一定是固定的双绞线端口或光纤端口。


刘晓辉.交换机·路由器·防火墙(第3版)(网管天下)(Kindle位置1012-1026).电子工业出版社.Kindle版本.



提•示与EtherChannel不同，STP只能保证在两台设备间拥有一条活动链路，因此，也就无法实现带宽加倍和负载均衡。

■　STP算法
IEEE802.1D标准定义了STP的生成树算法。该算法依赖于BID、路径开销和端口ID参数来做出决定。
•　BID（网桥ID）决定了桥接网络的中心，称为根网桥或根交换机。BID参数是一个8字节域，前2个字节（十进制数）称为“网桥优先级”，后6个字节（十六进制数）是交换机的一个MAC地址。网桥优先级小的BID优先，当网桥优先级相同时，BID中的后6个字节的MAC小的则BID优先。
•　路径开销决定到根网桥（根交换机）的路径。路径开销是用来衡量网桥之间的距离的远近的，路径开销与跳数无关，其值是两个网桥之间某条路径上所有链路开销的总和。最小的路径开销是到根交换机的最佳路径。带宽越大，STP开销越小。
•　端口ID
也决定到根交换机的路径。由2个字节组成，包括“端口优先级”和“端口号”，各占8位。端口ID大小的判定与BID相同。

STP通过发送BPDU（BridgeProtocolDataUnit，网桥协议数据单元）传递生成树协议，并执行判别过程，以生成无拓扑环的网络拓扑。BPDU是网桥之间用来交换生成树信息的特殊帧，包括根BID、根路径开销、发送者BID和端口ID信息。BPDU在网桥之间传播，包括交换机和所有配置来进行桥接的路由器。
判别过程如下：
（1）确定根交换机。
（2）计算到根交换机的最小路径开销。
（3）确定最小的发送者BID。
（4）确定最小的端口ID。

网桥为每个端口存储一个其收到的最佳BPDU，当有其他BPDU到达交换机的端口时，将依据上述顺序判断此BPDU是否比原来存储的BPDU更好。如果新收到的BPDU（或者本地生成的BPDU）更好，则替换原有值。

当一个网桥第一次被激活时，其上所有端口每隔一个HELLO时间（默认2s）发送一次BPDU；如果一个端口发现从其他网桥收到的BPDU比自己发送的好，则本地端口就停止发送BPDU；如果在最大老化时间（默认20s）内没有从邻居网桥收到更好的BPDU，则本地端口重新开始发送BPDU，即最大老化时间是最佳BPDU的超时时间。

■　STP过程

在网络第一次“初始化”时，所有网桥都泛洪BPDU信息，网桥通过执行判别过程，形成整个网络或VLAN唯一的生成树。在网络稳定后，BPDU从根网桥流出，沿着无环支路到达网络中的每一个网段。当网络发生变化时，生成树协议按照上述收敛步骤重新作出处理。

生成树算法收敛于一个无环拓扑的初始过程，包含3个选举步骤。
（1）选举一个根交换机。根交换机是一个具有最小BID的网桥，它是唯一的，是通过交换BPDU选举得出来的。也就是说，交换机通过传递BPDU来发现谁是最小的BID，从而将具有最小BID的网桥作为根交换机。最初时，交换机总将自己认为是根网桥，当它发现有比自己小的BID时，就将收到的具有最小BID的交换机作为根网桥。
（2）选举根端口。在根交换机选举完后，就开始选举根端口了。所谓根端口，就是按照路径开销最靠近根交换机的端口，也就是说具有最小根路径开销的端口。每一个非根交换机都必须选举一个根端口。
（3）选举指定端口。此时，生成树算法还没有消除任何环路，因为还没有选举指定端口。所谓指定端口，就是连接在某个网段上的一个桥接端口，它通过该网段既向根交换机发送流量也从根交换机接收流量。桥接网络中的每个网段都必须有一个指定端口。指定端口也是根据最小根路径开销来决定的，因此根交换机上的每个活动端口都是指定端口，因为它的每个端口都具有最小根路径开销（实际上它的根路径开销是0）。

提•示
指定端口只在中继端口（TRUNK口）起作用。接入端口在指定端口选举中不起任何作用。接入端口是用来连接到主机或者三层端口的。





■　STP端口状态

每个启用扩展树的交换机二层接口，都将处于以下几种状态之一。
阻塞（Blocking）——处于阻塞状态的接口不参与帧的转发。初始化之后，BPDU被发送至每个交换机接口。也就是说，阻塞状态接口不能接收或者转发数据，不能把MAC地址加入地址表，只能接收BPDU包。交换机作为根初始化，直至与其他交换机交换BPDU。该交换用于确定网络中哪台交换机是根或作为根交换机。如果网络中只有一台交换机，没有交换发生，转发延时计时器，接口将进入到侦听状态。交换机初始化之后，接口经常进入阻塞状态。或者说，处于学习、侦听或转发状态的端口，一旦检测到有桥接环，或者失去其根端口或指定端口的状态，将返回至阻塞状态。
侦听（Listening）——当扩展树决定该接口参与帧转发时，侦听状态为阻塞状态之后的第一个过渡状态。如果一个端口可以成为一个根端口或指定端口，即可进入侦听状态。此时接口不能接收或者转发数据，也不能将MAC地址加入地址表，但是，可以接收和发送BPDU包。
学习（Learning）——该端口准备参与帧转发。在转发延迟时间后（默认15s），端口进入学习状态。此时，该端口不能转发数据，但是，可以发送和接收BPDU包，也可以学习MAC地址，并将其加入地址表。
转发（Forwarding）——该端口转发帧。此时端口能够发送和接收数据，学习MAC地址并添加至地址表，也可以接收和发送BPDU包。
禁用（Disabled）——该端口没有参与扩展树，因为该端口处于关闭（shutdown）、未连接状态，或者该端口没有扩展树实例。为了管理或者因为发生故障将端口关闭。

接口状态变化过程如下（如图2-14所示）。
图2-14　扩展树接口状态变化过程
从初始化到阻塞。
从阻塞到侦听或禁用。
从侦听到学习或禁用。
从学习到转发或禁用。
从转发到禁用。



■　STP缺点
STP虽然能够解决拓扑环路的问题，不过，仍然存在以下缺陷。
由于整个交换网络只有一个生成树，在网络规模比较大的时候会导致较长的收敛时间，拓扑改变的影响面也较大。
IEEE802.1Q逐渐成为交换机的标准协议。在网络结构对称的情况下，单生成树没有什么问题。但是，在网络结构不对称时，单生成树就会影响网络的连通性。