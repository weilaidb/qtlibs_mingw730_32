18.2PVST概述
之前在介绍生成树的相关知识时，我曾义正严辞地强调了在没有生成树的环境中，网络会面临的灾难性后果，让大家对于环路如临大敌。但其实，在交换机启动时，生成树协议就已经自动运行了，交换机无需人为干预，就会自动为我们解决这些恼人的环路。之所以把这个彩蛋留到最后，就是担心大家知道后会没有耐心学习STP的计算原则，这将非常不利于继续学习PVST的配臵。生成树的必要性大家已经了然于胸，现在来看看手动配臵生成树的必要性。一般我们在建设园区网时，是按照层级化的结构进行设计的，分为核心层、分布层以及接入层。因此对于STP中的根网桥来说，我们希望由性能更好的核心层或者分布层的交换机来充当，这样做的好处之一是流量无需“绕远路”，好处之二是性能好则转发能力强。但若让STP自行选举根桥，无法保证网络的性能达到最佳。除此之外，在层级化的网络结构中，我们通常会在核心层和分布层部署冗余交换机。就算根网桥由这两层中的设备来担任，STP也会通过阻塞端口打破冗余环路，这样一来，冗余设备的设计方案实际上就成了“备份路径”方案。要想让两台设备真正实现流量分担，还是要由管理员出面干预，如图18-3所示。
从图18-3所示拓扑可以看出，网络中共有10个VLAN。通过管理员的干预，最终实现让分布层交换机成为STP根网桥，且交换机A是VLAN1～5的根网桥，交换机B是VLAN6～10的根网桥。如果我们回忆一下第16章介绍的STP选举原则，就会发现我们只要在交换机A和B桥上修改ID中的优先级值，就可以让它们成为根网桥。那么如何能够根据VLAN的不同，让它们分别成为VLAN1～5和VLAN6～10的根网桥呢？这就要得益于Cisco的私有STP协议——PVST（每VLAN每生成树）。



18.3PVST配置在本节，我们将以一个案例拓扑（见图18-4）为大家展示PVST的配臵。在图18-4所示的案例拓扑中，SW1和SW2是分布层交换机，SW3和SW4是接入层交换机。本着将根网桥安臵在网络中心位臵的原则，我们要把SW1和SW2设置为根网桥，其中SW1为VLAN1的根网桥，SW2为VLAN2的根网桥。将一台交换机配臵为根网桥有两种方法，都是通过全局命令实现的。一种是自定义优先级值，命令为“spanning-treevlanVLAN号root优先级值”；在这条命令中的优先级值要设臵为4096的倍数；另一种是使用关键字primary进行配臵，具体的命令为“spanning-treevlanVLAN号rootprimary”，这条命令会将优先级值设臵得小于当前网络中最低的优先级值。此时，如果SW1出了问题，VLAN1的根网桥就会重新选举。显然，我们希望重新选举的结果是由同为分布层交换机的SW2当选。所以，我们还可以把交换机SW2设置为VLAN1的从根网桥，同时把交换机SW1设置为VLAN2的从根网桥。这次我们仍分别使用关键字（secondary）和优先级值进行设臵。

田果CCIE#19036;彭定学CCIE#12197.趣学CCNA路由与交换（异步图书）(p.521).人民邮电出版社.Kindle版本.