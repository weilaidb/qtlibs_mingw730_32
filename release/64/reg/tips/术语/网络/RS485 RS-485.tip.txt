图文详解RS-485，真的很详细了
逸珺
逸珺

[导读] Hi 大家好，我是逸珺。前面一篇文章总结整理了工业HART总线，今天来聊聊RS-485。RS-485也是工业领域应用非常广泛的一种通信接口，本文来整理一下容易让人忽略的点。
前世今生

RS-485,啥是RS呢？是Recommended Standard的缩写，就是推荐标准的意思。485是标识号，至于为什么定这个标识号，则无需深究。RS-485又称为ANSI/TIA/EIA-485，这几个前缀是标准协会的名称缩写，比如EIA就是电子工业协会 (Electronics Industries Association EIA)的缩写。1983年，RS-485通讯接口被电子工业协会 (Electronics Industries Association EIA)批准为一种通讯接口标准。

使用RS-485作为物理层的常用标准协议有哪些呢？比如：

    工业HART总线modbus协议Profibus DP

电气特性

信号采样差模传输，差模是相对于共模而言的，差模也称为差分，那么什么样的情况是差模呢？一图胜千言，看下面两个图就明白了：
共模传输

采用共模传输方式时，共模噪声将会叠加在最终的输出信号上面，污染了原始的信号。
差模传输

而采用差模传输方式，则源端发出的信号+与信号-相位是相反的，而对于共模噪声而言在+/-两条线上都会存在，理想情况是等幅同相的，而接收端，相当于一个减法器，有用信号由于相位相反则经过减法器仍然保留，而噪声则会被抵消。而实际电路中，则会大幅度削弱。

由此可见，差模传输相对于共模传输方式，优势在于差模方式可以有效抵消共模干扰。

差模方式在有的地方又称为平衡模式，而共模模式也称为非平衡模式。对于这个干扰，我们来实际抓个波形看看：

在A/B信号的边缘处，波形都略微有些变形，但是你看A-B做差（红色的为示波器的MATH功能），边沿则变得非常的干净！这就很好的说明了差模可以有效的抵抗共模干扰。
电气参数

RS-485的电气参数为：

    共模电压范围为-7～+12V可支持32个多点拓扑连接，见下面的网络拓扑图使用40英尺线缆时，传输速率可达到10Mbps，1英尺相当于30.48cm，这里Mbps是兆bit/s的意思使用4000英尺线缆时，传输速率可达到100kbps半双工通信最小差分电压容限：200mV,也就是说接收端在差分电压低于200mV时就无法正确识别0/1了。这句话应该怎么理解呢？

上面这个图怎么理解呢？RS-485收发器的发送电路至少提供1.5V差分电压输出能力，经由总线线路阻抗衰减，32个接收电路输入阻抗，以及120Ω端接电阻，差分信号的幅度必然逐渐衰减，那么至最末端还需要至少提供200mV的差分电压给末端接收电路。

    ：对于接收电路是判决A线共模电压与B线共模电压之差：

    如果 

,则接收电路R识别为逻辑 1如果

    ,则接收电路R识别为逻辑0

简单说就是，A线的绝对电压值比B线的至少大于200mV则识别为逻辑1，或者A线的绝对电压值比B线的至少小200mV，才识别为逻辑0

这里的参数，应该是在一定特征阻抗线缆时的理论值，实际工程使用的时候需要做相应的调整以及现场测试。一般以不超出这个理论极限为好。

说到电气特性参数，首先来看看一般的接口电路：

从这样一个接口电路来看，有这么些要点：

    RS-485通信从单片机/DSP/处理器接口而言，是利用UART接口与RS-485电平收发器接口。当然你说我用FPGA难道不行么？肯定是可以的，用FPGA你实现一个串口收发的IP模块，当然也是可以的。甚至你想说，我拿GPIO去模拟一下UART是不是就不行？也是能办得到的，只不过这么干意义不大，需要占用CPU资源实现底层BIT的收发。
    前面说到半双工，有半双工就有全双工。什么是半双工呢？首先半双工以及全双工，所界定的对象一定是点对点而言的，这里说点对点就是指在同一时刻而言，所谓半双工，就是设备在同一时刻要么处于收数据状态，要么处于发数据状态，不允许同时收发数据。而全双工则刚好相反，允许同时收发。比如I2C总线就是半双工总线，4线制SPI是全双工，而三线制SPI则是半双工总线；又譬如RS-422或者RS-232是全双工接口；而CAN总线则是半双工总线。RS-485就是一种半双工总线： 

当Host发送数据时，数据沿着红色的线经由双绞线，传输至Slave的差分接收电路，当slave应答时，数据沿着兰色的方向传输至Host的接收电路，但是传输介质是一对双绞线，所以一方在传输数据的时候，另一方是无法传输信号的，从收发器的控制角度来看：

        : Receiver Output Enable,接收器使能，DE：Driver Output Enable，驱动输出使能

控制芯片侧，用一个GPIO脚来控制和

，刚学设计RS-485的朋友或许不理解，这里来一张芯片内部原理框图，就很容易理解了：

当DIR=0时，接收电路使能
，发送电路禁止DE=0，对总线而言相当于高阻；当DIR=1时，接收电路使能，发送电路禁止DE=1，对总线A/B信号取决于DI的信号。这里有两个问题：
1.为什么芯片要把和

设计成相反的有效逻辑呢？这样其实也是方便用一个GPIO同时控制收发电路的考虑。
2.那收发器芯片收发使能为什么不做成一个脚呢？比如就叫DIR？做成两个脚收/发也可以用两个脚单独控制，比如：


甚至可以在DE=1的时候，将

设置为0，这样是不是就可以自环了？产品中也可以就这样设计，可以实现收发器以及布线的自诊断，通过接收到的报文与发送出去的报文比较，可以诊断出芯片焊接，收发器是否损坏或者断路，以及布线是否存在短路故障。
或许有人会说，瞎扯！你前面才说RS-485不能同时收发，这里又说能同时收发，岂不是自相矛盾吗？不矛盾，前面所说的不能同时收发，是指发的同时不能收来自其他设备的发送报文，这里收的是自身发出的报文。
所以半双工的本质，是通讯介质不存在双向通道，在向总线发送数据的时候，介质被占用，即便想发送也是无法正确的将信号发送到介质上的，如果强行发送，数据将会错乱，甚至收发器芯片有可能损坏。

    图中的DIR脚就是控制当前RS-485是处于“收”还是处于“发”模式。

前面说到共模电压指标以及差模传输方式，这里来实际抓抓波形看看：

示波器的CH2接485输出A端，CH3接485输出A端，红色的为示波器的MATH功能：CH2-CH3。大部分示波器都具有数学运算功能。如果想看差分信号，就可以利用双通道示波器加MATH减功能观测。或许有的示波器没有MATH功能，那么这里还可以使用一个技巧：

将B通道，或者说差分信号的负端反相，然后将B通道上移至空闲电平重合，这样是不是也就比较直观的可以看出A-B了？

通过这个图，能发现哪些有价值的信号特征呢？

    信号A在空闲时候为高电平；信号B在空闲时为低电平。所以你会看到有设备上会标识485_A+，485_B-。 每个通道的共模电压值都在标准要求的-7～12V之内，信号A为4V，信号B为5V：

那么数据怎么去解读呢？

这里抓的数据是一个MODBUS-RTU主端发送给从设备的报文，其内容前面两个字节是0x01 0x03，UART模式为1个起始位，8个数据位，1个停止位，无校验位，低位在前，此例中UART的通讯格式为

先根据UART通讯模式，来计算一下几个参数，每bit占用时间，每字节占用时间：

这个图就是起始位，宽度正好是104us。

对于解析这种异步串行时序波形而言，最重要就是根据通信格式计算位时间，字节时间，进而可以直接解析波形数据。从这一点思考，假设要利用FPGA来实现一个UART协议逻辑分析仪，这就是最为核心的指标，通过检测到起始位边沿，进而通过时间轴将数据解析出来。这里我来充当一个肉眼UART逻辑分析仪吧：

8bit数据的时间宽度刚好是832us，由于格式是低位在前，所以要反过来看，与实际发送的数据0x01 0x03是吻合的，这里在调试底层的时候遇到问题，就可以通过这种方式可以检查软件是否正确的驱动了硬件，譬如在调试I2C/SPI等等其他底层接口的时候，都可以类似的去检查硬件波形，唯一不一样的是，I2C/SPI属于同步通信，所谓同步通信，是指其通信底层有同步时钟信号，I2C的SCL,SPI的SCK都属于同步时钟。
驱动能力

电气参数里总结说RS-485最大电气驱动能力，在多点网络拓扑结构下，可最大驱动32个站点。那么怎么去解读这一指标呢？

首先来考察一个站点收发电路特性，收发器的接收电路其标准等效输入阻抗为12kΩ,比如MAX 485数据手册为例：

至于为什么是32个，你可以想象一下，每一个接收电路输入阻抗并非理想的高阻，而是12kΩ，那么比如其中一个站点发送，就相当于有32个站点的输入阻抗并联，为什么是32个呢？别忘了发送站点自身也有接收电路，所以在不考虑端接电阻以及线路阻抗的情况下，对于发送电路接了一个等效负载：

，而发送电路驱动能力肯定是有限的，这样就好理解了。

下面这个图就是所谓的多点网络拓扑，所有的站点都是沿着双绞线的排布并接在总线上的。

所以，你有可能会在一些地方看到所谓的一个单位RS-485负载的说法，这里所谓的单位负载就是指12kΩ标准输入阻抗，这个12kΩ就是EIA-485标准定义的。从而看到比如

单位负载之类的说法，就是源于此处。
数据监控

比如一个基于RS-485的Modbus-RTU多点网络中，在做协议编程或者实际多站点总线调试的时候，有可能需要监控总线上所有的报文。甚至还有可能就像实现一个总线报文的的记录器，将总线上所有的报文都记录下来。应该怎么实现呢？

买一根USB转RS-485的转换线或者自己做一个也可以。将A/B线并接在总线上，USB插入电脑。使用串口监控终端或者自己写一个串口接收小软件，就可以监控所有总线上的报文了。

比如这个AccessPort就比较好用：
应用设计

作为应用设计而言，需要考虑这些维度：

    端接设计接口芯片隔离设计

端接设计

首先为什么要端接？这是由于RS-485采用双绞线传输，标准规定的双绞线的差分特征阻抗在100Ω至150Ω之间。RS-485标准制定者选择120Ω作为标称特征阻抗。

假定信号自左边站点发出，如果没有端接。信号在线路上传输其阻抗是连续的，但是到达右侧的时候则，等效阻抗变成了接收电路的输入阻抗，比如是12kΩ,阻抗不连续了，信号的一部分能量就会按照原路径返回，如返回回去的信号由于容抗及感抗，就会产生相差。反射回去的信号与原信号就会被叠加在一起。这样就会造成通信发生错误的可能，严重的时候，通信就无法正确进行。要想更深入的了解背后的原理，可以去学习一下传输线理论。

或许做过Profibus DP（物理层也是采用的RS-485）的朋友会说，你看profibus DP为什么推荐的终端匹配电路是下面这样的呢？

其实是因为Profibus DP采用的通信介质其标称特征阻抗不一样。所以实际工程应用的时候则会有小的差异。在TI的资料上看到这样一个端接接法：

在噪声比较严重的场合，建议使用右边的端接方案，利用两个60Ω电阻以及220pF电容形成低通滤波器，将增加线路的抗噪声能力。

在实际工程布线的时候，如果遇到噪声比较严重的时候，一方面可以利用示波器查看总线信号质量，在将端接方式做一些小的调整。
接口设计

RS-485收发器芯片很多芯片公司都提供，比如TI,Microchip等厂家都有，选择接口芯片的时候需要考虑，芯片的供电电压输入逻辑是否与使用的单片机/DSP的电平兼容，另外就是前面提到的其接收电路的阻抗是否是符合RS-485标准输入阻抗的。如果不是的，那么在考虑网络部署的时候，所能带的负载数量就有可能需要做调整。另外注意一下，有的新设计RS-485收发器具备fail-safe功能。

另外，前面说到标准收发器可以驱动32个标准收发器负载设备，也即是（12kΩ)标准单位输入阻抗。

在做具体接口电路设计的时候还需要考虑EMC要求，在一些设备现场真的有很强的干扰，比如电网上有大的电机等感性设备运行，有时候就会干扰设备；另外也有可能有空间辐射干扰，这时候可以考虑采用带屏蔽双绞线，屏蔽层接大地，抗干扰方面我了解的不是很深入，仅整理一下。在这里看到一个防雷接口电路的设计方案，可以参考一下：

https://www.programmersought.com/article/95833359295/

前面说通常标准RS-485可以容纳32个标准接收阻抗收发设备。实际系统中就是想接入超过32个站点设备，怎么办呢？可以设计一个中继设备。想当于将两个网段利用中继给衔接起来，以解决驱动能力不足的问题。当然也有这样的现成产品。
隔离设计

为什么要隔离，是为了降低接地噪声。在很多现场可能有大电流开关设备，电机感性设备等，噪声很有可能通过通讯的接地耦合进设备。尤其在工业设备中，一般都会设计成带隔离的接口电路。要设计隔离接口，可以考虑选择具有隔离功能的芯片，比如ADI的 iCoupler技术产品ADM2481，ADM2485。当然也可以采用光耦+普通RS-485收发器的方式。唯一需要注意的是需要设计一个带隔离的电源，给隔离两侧电路分别供电。

上面这个图来自TI的《The RS-485 Design Guide》，这份资料感觉很不错，本文很多地方也参考这份文档整理的。如对这份资料有兴趣，可以在后台回复485自动领取。
总结一下

RS-485看似简单，实际应用的时候还是有很多需要去理解和注意的地方。做一个稳健的产品，往往所差不是大方向，而是在一些细微处容易导致产品不稳定。

版权所有，如需转载，请申请，该文章首发于：
RS-485总线，这篇很详细​
mp.weixin.qq.com/s/plW_kt4k6uB6iXD8jlVRRg

