2.5 网络协议栈各部分初始化
协议栈本色的初始化这部分在 2.6 早期和后期是不太一样的，早期的是通过函数直接调用的方式，
后期更加依赖于使用 init.h 中定义的初始化宏来进行，即放入特定的代码段去执行。所以再次强调关于内
核镜像研究的重要性。我们先给出初始化大致的顺序，大家记住这个顺序就对初始化有关全局的了解：
○1 core_initcall：sock_init 
○2 fs_initcall：inet_init 
○3 subsys_initcall：net_dev_init
○4 device_initcall:设备驱动初始化
上面那句话揭示了初始化的顺序，读者可以看到源代码中sock_init，inet_init，设备驱动初始化是分
别被core_initcall、fs_initcall、subsys_initcall 、device_initcall函数修饰的，根据前文对初始化section的
描述，这四个函数放在不同的section，而且执行顺序是从○1 到○4
的。所以我们对初始化的描述也是按照这个顺序进行。


2.5.2 网络内存管理
关于内核中网络部分的内存管理，凡涉及到内核的 Linux 参考书都会提及，在本书中不会对它大书
特书，只是给出一些基本的概念，读者只要能基本理解网络内部内存的管理思路即可。
2.5.2.1. sk_buff 结构
数据包在应用层称为 data，在 TCP 层称为 segment，在 IP 层称为 packet，在数据链路层称为 frame。
Linux 内核中 sk_buff{}结构来存放数据，在不同的层次会使用上面几种术语来称呼，但这没有什么太大
区别。sk_buff{ }在 INET Socket 和它以下的层次中用来存放网络接收到或需要发送的数据，因此它需要
设计得要有足够的扩展性，从而可以支持不同层次、相同层次不同类型的网络协议。另外，还必须高效、
紧凑。

可以用 eth_type_trans 函数获取 protocol 的值，如果以太网头大于 1536，那么就返回以太网的 h_proto
值，下面时常用值
unsigned short protocol,
宏 值 说明
ETH_P_802_2 4 真正的 802.2 LLC，当报文长度小于 1536 时
ETH_P_LOOP 0x0060 以太网环回报文
ETH_P_IP 0x0800 IP 报文
ETH_P_ARP 0x0806 ARP 报文
BOND_ETH_P_LACPDU 0x8809 LACP 协议报文
ETH_P_8021Q 0x8100 VLAN 报文
ETH_P_MPLS_UC 0x8847 MPLS 单播报文

sk_buff.pkt_type 是指该数据包的类型，定义如下：
表格 2-1 宏 值 说明
PACKET_HOST 0 该报文的目的地是本机
PACKET_BROADCAST 1 广播数据包，该报文的目的地是所有主机
PACKET_MULTICAST 2 组播数据包
PACKET_OTHERHOST 3 到其他主机的数据包，在 VLAN 接口接收数据时有重要的
作用
PACKET_OUTGOING 4 它不是“发送到外部主机的报文”，而是指接收的类型，这
种类型用在 AF_PACKET 的套接字上，这是 Linux 的扩展
PACKET_LOOPBACK 5 MC/BRD 的 loopback 帧（用户层不可见）


函数列表      功能说明
sock_init     网络基础系统初始化 
sock_init     
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      
sock_init      